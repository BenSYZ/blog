<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>ssh 免密登录</title><script src=/js/if_mobile.js></script>
<script>!function(){$("pre > code").each(function(){var s,n=$(this).parent().attr("class");n==null||n===""?$(this).addClass("hljs"):(s={js:"javascript"},s[n]&&(n=s[n]),$(this).addClass(n))})}</script><link rel=stylesheet href=/css/hljs/snazzy.css><link rel=stylesheet href=/css/hljs/line-numbers.min.css><script src=/js/hljs/highlight.min.js></script>
<script src=/js/hljs/highlightjs-line-numbers.min.js></script>
<script>hljs.highlightAll()</script><script>hljs.initLineNumbersOnLoad()</script><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=icon id=light-scheme-icon href=/favicons/favicon_B_Light.ico type=image/x-icon><link rel=icon id=dark-scheme-icon href=/favicons/favicon_B_Dark.ico type=image/x-icon><script src=/js/favicon.js></script></head><body><div class=container><div class=header><h1>ssh 免密登录</h1>Fri, 2021-02-05<hr></div><div class=middle><div id=TitleWithToc><div id=TitleOfToc>ssh 免密登录</div></div><div id=content><h2 id=rsa简介>rsa简介</h2><h3 id=rsa>rsa</h3><h4 id=什么是rsa><a href="http://www.baidu.com/link?url=E7VV9LiPjbQHlSeIcFqyi_sx7fSDsVr8zPdlhSn7GVcsXuA5uiwUEmqmHXNQoJyroo71V84SlMGwRAML75z7D8HCAxMS6Ovzlljv0_Pr8DUNGyzrqNQWbsqTpXBlfsDAQfUx78JGfySl5JN4km2Qka&amp;wd=&amp;eqid=f42870ad0000ace4000000055e393bea">什么是rsa</a></h4><p>RSA加密算法是一种非对称加密算法。在公开密钥加密和电子商业中RSA被广泛使用。它的基本原理是利用大数难以质因数分解，它有一对数字： 1. 密钥(<a href=https://zhidao.baidu.com/question/1579778969145333380.html>yao4</a>)：绝对<strong>不能</strong>透露给别人。 2. 公钥：是要给别人的。</p><p>具体原理请见阮一峰的<a href=http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html>blog</a></p><h4 id=rsa的用途>rsa的用途</h4><h5 id=身份验证><a href=www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html>身份验证</a></h5><p>所谓“公钥登录”，原理很简单，就是用户将自己的公钥储存在远程主机上。登录的时候，远程主机会向用户发送一段随机字符串，用户用自己的私钥加密后，再发回来。远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的，直接允许登录shell，不再要求密码。</p><h5 id=数字签名><a href=https://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html>数字签名</a></h5><p>数字签名用于发行软件时防止别人篡改，具体流程是这样的：</p><ol type=1><li><p>发行者对文件进行hash校验，并把这个校验值和进行私钥加密得到<em>数字签名</em>，大家通过<em>公布在网站上的公钥</em>解开这段密文（数字签名），也就是文件的hash值。</p></li><li><p>下载者对文件进行hash校验，和1.中得到的hash值进行比对。</p><p>上面两个步骤如何防止第三方修改，发行者加密的文件第三方当然可以通过公钥解密之后修改，但是你也无法生成（到时候用户要用公布在网站上的公钥解密的）<em>数字签名</em>（必须知道密钥）。</p></li></ol><hr><h2 id=ssh用rsa方式登录远程主机>ssh用rsa方式登录远程主机</h2><h3 id=为什么要用rsa登录>为什么要用rsa登录</h3><ol type=1><li>方便，每次登录不用输密码。</li><li>安全，禁用密码登录后，不怕别人猜到密码。</li></ol><h3 id=文件信息>文件信息</h3><p>本文会涉及两个文件夹，一个是在客户端（client），一个是服务器端（server）：</p><ul><li>rsa 密钥位置(<strong>client</strong>)：<code>~/.ssh/</code></li><li>ssh 配置文件(<strong>server</strong>)：<code>/etc/ssh/sshd_config</code></li></ul><p>client 和 server 是相对的概念，在一次连接中，主动寻求连接的是 client ，被连的是 server。</p><h3 id=如何配置>如何配置</h3><h4 id=client>client</h4><ol type=1><li><strong>生成密钥对：rsa 和 rsa.pub</strong></li></ol><div class=sourceCode id=cb1><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true></a><span class=fu>ssh-keygen</span> -t rsa</span></code></pre></div><p>得到</p><pre><code>Generating public/private rsa key pair.
# 输入rsa对（`id_rsa`和`id_rsa.pub`）名称（带路径）
Enter file in which to save the key (/home/user/.ssh/id_rsa):

# 输入密码，使用rsa密钥时（这里就是登录远程主机时）用的
Enter passphrase (empty for no passphrase):
Enter same passphrase again:</code></pre><p>将会生成</p><ul><li><code>rsa</code>: 密钥</li><li><code>rsa_rsa.pub</code>: 公钥</li></ul><ol start=2 type=1><li><strong><a href=https://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html>将<code>rsa.pub</code>附加到server <code>~/.ssh/authorized_keys</code>的文件内</a></strong></li></ol><div class=sourceCode id=cb3><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb3-1><a href=#cb3-1 aria-hidden=true></a><span class=co># Following 2 commands are excuted on client</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true></a><span class=ex>ssh-copy-id</span> [-i ~/.ssh/rsa.pub] user@host</span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true></a><span class=co># or</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true></a><span class=fu>ssh</span> user@host <span class=st>&#39;mkdir -p .ssh &amp;&amp; cat &gt;&gt; .ssh/authorized_keys&#39;</span> <span class=op>&lt;</span> ~/.ssh/id_rsa.pub</span></code></pre></div><p>一个粗暴的办法，复制client内的<code>id_rsa.pub</code>的内容，登录server，附加到<code>~/.ssh/authorized_keys</code>中</p><h4 id=server>server</h4><ol type=1><li><strong><code>/etc/ssh/sshd_config</code> 的配置</strong></li></ol><div class=sourceCode id=cb4><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true></a><span class=co># 允许公钥登录</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true></a><span class=ex>PubkeyAuthentication</span> yes</span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true></a></span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true></a><span class=co># 由 client 生成的公钥，可以添加多个，多行，自己注释</span></span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true></a><span class=ex>AuthorizedKeysFile</span>  .ssh/authorized_keys</span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true></a></span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true></a><span class=co># 是否允许用密码登录</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true></a><span class=co># 禁用后，如果密钥丢失就不能登录远程主机了</span></span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true></a><span class=ex>PasswordAuthentication</span> yes</span></code></pre></div><p>可以找到相应的项并取消注释。</p><p>可能你的系统用的是第一版ssh协议需要添加 <code>RSAAuthentication yes</code> 这一项来允许rsa方式登录，或者在<code>/etc/ssh/sshd_config</code>中<a href=https://www.cnblogs.com/Leroscox/p/9627809.html>添加</a></p><pre class=config><code>Protocol 2</code></pre><p><em>更多详细帮助见<code>man sshd_config</code></em></p><ol start=2 type=1><li><strong><a href=https://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html>重启远程主机的ssh服务</a></strong></li></ol><div class=sourceCode id=cb6><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb6-1><a href=#cb6-1 aria-hidden=true></a><span class=co>#ubuntu系统</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true></a><span class=ex>service</span> ssh restart</span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true></a></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true></a><span class=co>#debian系统</span></span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true></a><span class=ex>/etc/init.d/ssh</span> restart</span></code></pre></div><h3 id=连接>连接</h3><div class=sourceCode id=cb7><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true></a><span class=fu>ssh</span> user@host -i .ssh/rsa</span></code></pre></div><h2 id=附不用输入nameip的方法>附：不用输入<code>name@ip</code>的方法</h2><p>对 <code>~/.ssh/config</code> 进行配置配置</p><pre class=sshconfig><code>Host ubuntu
    # 远程主机 ip， `ssh name@ip` 中的`ip`
    HostName X.X.X.X

    # 远程主机 端口号(port), 默认是22，termux: 8022
    Port 22

    # 登录名， `ssh name@ip` 中的`name`
    User name

    # rsa密钥，对应的公钥放在server上(若无此项，则用密码登录)
    IdentityFile ~/.ssh/id_rsa</code></pre><ul><li>更多参数详见帮助<code>man ssh_config</code></li></ul><p>这样就可以直接通过</p><div class=sourceCode id=cb9><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb9-1><a href=#cb9-1 aria-hidden=true></a><span class=fu>ssh</span> ubuntu</span></code></pre></div><p>来登录远程主机</p><h2 id=附ssh-keygen-公钥如果丢失由私钥生成公钥>附：ssh-keygen 公钥如果丢失，由私钥生成公钥</h2><div class=sourceCode id=cb10><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb10-1><a href=#cb10-1 aria-hidden=true></a><span class=fu>ssh-keygen</span> -y -f id_rsa <span class=op>&gt;</span> id_rsa.pub</span></code></pre></div><p>生成的<code>id_rsa.pub</code> 相比于自动生成的少了最后一项，但是没关系因为<code>rsa.pub</code>的<a href=https://blog.csdn.net/weixin_34051201/article/details/92480568>格式</a>： 一般分为三部分：密钥类型、base64编码后的密钥、注释(可选)。中间用空格分开。</p><p><strong>注意</strong>：这里生成的是公钥，就如之前说的从公钥是几乎不可能找回私钥的</p><h2 id=附ssh-时的fingerprint作用>附：ssh 时的fingerprint作用</h2><div class=sourceCode id=cb11><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb11-1><a href=#cb11-1 aria-hidden=true></a>$ <span class=fu>ssh</span> localhost</span>
<span id=cb11-2><a href=#cb11-2 aria-hidden=true></a><span class=ex>The</span> authenticity of host <span class=st>&#39;localhost (127.0.0.1)&#39;</span> can<span class=st>&#39;t be established.</span></span>
<span id=cb11-3><a href=#cb11-3 aria-hidden=true></a><span class=st>ECDSA key fingerprint is SHA256:o2cGXCQtdhvWUXG8liYGWJrhVuP4YF9/E839KY1HqH4.</span></span>
<span id=cb11-4><a href=#cb11-4 aria-hidden=true></a><span class=st>Are you sure you want to continue connecting (yes/no)?</span></span></code></pre></div><p>这个是为了防止我连接的server不是我想连的server，有可能是假的。这个fingerprint是用来确认server的身份的。这个就是我们之前提到的rsa公钥，只不过这次的fingerprint是server的。</p><h2 id=附不要验证fingerprint>附：不要验证fingerprint</h2><p>局域网内ip会变，验证不通过很不方便，可以这样配置<code>~/.ssh/config</code> 例如：</p><pre class=conf><code>Host ubuntu
    ...
    StrictHostKeyChecking no</code></pre></div><div id=Rsidebar><div id=Avatar><img alt=avatar src=/avatar.jpg></div><ul><li><a href=/about>About Me</a></li><li><a href=/donate>Donate Me</a></li><li><a href=/>Ben's Blog</a></li></ul>除非注明，本博客所有文章皆为原创。<br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></div><div class=footer><div id=tags><a href=https://bensyz.github.io/blog/tags><i class="fas fa-tags"></i></a>
Keywords:<ul><li><a href=https://bensyz.github.io/blog/tags/rsa>rsa</a></li><li><a href=https://bensyz.github.io/blog/tags/ssh>ssh</a></li><li><a href=https://bensyz.github.io/blog/tags/newbie>newbie</a></li></ul></div><footer><hr><a href=/>Ben's Blog</a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<br><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33028102001039"><img alt=public_safety_record src=/icons/public_safety_icon.png>浙公网安备 33028102001039号</a>
<a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备2021032097号-1</a></footer></div></div></body></html>