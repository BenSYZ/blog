<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>用 curl 来制作一些简单的网络小工具</title><script src=/js/if_mobile.js></script>
<script>!function(){$("pre > code").each(function(){var s,n=$(this).parent().attr("class");n==null||n===""?$(this).addClass("hljs"):(s={js:"javascript"},s[n]&&(n=s[n]),$(this).addClass(n))})}</script><link rel=stylesheet href=/css/hljs/snazzy.css><link rel=stylesheet href=/css/hljs/line-numbers.min.css><script src=/js/hljs/highlight.min.js></script>
<script src=/js/hljs/highlightjs-line-numbers.min.js></script>
<script>hljs.highlightAll()</script><script>hljs.initLineNumbersOnLoad()</script><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=icon id=light-scheme-icon href=/favicons/favicon_B_Light.ico type=image/x-icon><link rel=icon id=dark-scheme-icon href=/favicons/favicon_B_Dark.ico type=image/x-icon><script src=/js/favicon.js></script><style>.mermaid svg{display:block;margin:auto}</style><script defer src="data:text/javascript,Array.from(document.getElementsByClassName(%22mermaid%22)).forEach(e=%3E%7Be.outerHTML=%60%3Cspan%3E%3Cdiv%20class='mermaid'%3E$%7Be.innerText%7D%3C/div%3E%3C/span%3E%60%7D)"></script>
<script src=js/mermaid.core.min.js></script></head><body><div class=container><div class=header><h1>用 curl 来制作一些简单的网络小工具</h1>Sat, 2021-10-09<br>本文最后修改于 Wed, 2021-11-24<hr></div><div class=middle><div id=TitleWithToc><div id=TitleOfToc>用 curl 来制作一些简单的网络小工具</div></div><div id=content><h2 id=问题的出现碎碎念>问题的出现（碎碎念）</h2><h3 id=校园网登录>1. 校园网登录</h3><p>校园网需要认证后才能登录上网，在使用 Linux 的时候有一点很麻烦，宿舍区必须使用客户端才能登录，不能像教学区那样可以网页登录，不知道是谁告诉我们宿舍区也可以网页登录，网址是:</p><pre><code>http://172.30.255.2/a30.html</code></pre><p>于是宿舍区使用 Linux 的问题得以解决。但是每次断网都要打开浏览器去连接也不是很方便，我想是否可以使用爬虫来实现登录，找着找着发现可以用 <code>curl</code> 来实现登录。</p><h3 id=宿舍电费查询>2. 宿舍电费查询</h3><p>这个小工具的出现的起因是宿舍如果没电了，夏天早上会断电，我的树莓派会被强制断电，对 SD 卡不好于是我想每天做个定时任务爬一下宿舍电费是多少，一开始也是想用 selenium 爬虫做的，但是 selenium 太吃资源，于是我又找着找着想到了 <code>curl</code>，然后就成了。</p><h2 id=curl-简介><code>curl</code> 简介</h2><p>我们常用 <code>curl</code>、<code>wget</code> 在 Linux 上下载东西：</p><div class=sourceCode id=cb2><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true></a><span class=ex>curl</span> www.baidu.com</span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true></a><span class=fu>wget</span> www.baidu.com</span></code></pre></div><p>而我们知道网络里有的不止是从服务器上下载内容，还有提交内容到服务器上。要怎么提交呢？</p><p>方法很简单就是使用 <code>-d</code> 参数，语法如下：</p><div class=sourceCode id=cb3><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb3-1><a href=#cb3-1 aria-hidden=true></a><span class=ex>curl</span> -d <span class=st>&#39;variable=value&#39;</span> URL</span></code></pre></div><p>Windows、Linux、Mac 一般都有 <code>curl</code> 命令，Windows 没有的话可以去这里下 <a href=https://curl.se/windows>https://curl.se/windows</a></p><h2 id=如何制作>如何制作</h2><p>上面说的 <code>curl</code> 来贴一个 POST表单，可能很难理解，我们借 drcom 来举一个例子，给大家介绍一下如何制作两个使用 <code>curl</code> 的小工具。</p><h3 id=登录-drcom-校园网>登录 drcom 校园网</h3><p>这里再提一下两个登录的网页地址，教学区这个域名默认的网页就是登录界面，但是宿舍区上网自动跳转的界面是让你下载客户端，但是<code>a30.html</code>是可以和教学区那样实现网页登录的：</p><ul><li>教学区： <code>https://drcom.szu.edu.cn</code></li><li>宿舍区： <code>http://172.30.255.2/a30.html</code></li></ul><p>前面说到 <code>curl</code> 登录需要提交一份包含登录信息的表单。那这个表单是怎么样的呢？</p><ol type=1><li><p>在浏览器中打开登录网页，并输入帐号密码，<strong>不要登录</strong>。</p></li><li><p>打开调试，选择<code>网络 (Network)</code>， 并勾选<code>保留日志 (Preserve log)</code>(Firefox 默认保留）</p></li></ol><figure><img src=./figures/2.fn12_preserve_log.png alt><figcaption>Fig. 1</figcaption></figure><p>打开调试的方法：</p><ul><li>Chrome, Firefox: F12</li><li>Mac 的 Safari:<ol type=1><li>Safari 浏览器 > 偏好设置 > 高级 > 在菜单栏中显示“开发”菜单</li><li>开发 > 显示 JavaScript 控制台</li></ol></li></ul><ol start=3 type=1><li>点击登录，调试框内会显示新的各种请求接受包</li></ol><figure><img src=./figures/3.after_login.png alt><figcaption>Fig. 2</figcaption></figure><ol start=4 type=1><li>点最上面的<code>a30.html</code>，点<code>标头 (Headers)</code>，这是一个<code>POST</code>包，并拉到最下面。</li></ol><figure><img src=./figures/4.pull_to_end.png alt><figcaption>Fig. 3</figcaption></figure><ul><li>Chrome 和 Firefox 更新了，表单是单列了一条（Payload/请求）<ul><li>Chrome:<br><img src=./figures/chrome_payload.png alt="Fig. 4"></li><li>Firefox:<br><img src=./figures/firefox_post.png alt="Fig. 5"></li></ul></li></ul><ol start=5 type=1><li>看到输入的帐号密码（别的地方的 WIFI 可能是被加密过的，但没关系，拷下来就是），以及一个<code>0MKKEY</code>，点击<code>view URL encoded</code>，<code>0MKKEY</code> 显示出来了。</li></ol><figure><img src=./figures/5.click_view_url_encoded.png alt><figcaption>Fig. 6</figcaption></figure><p>这个就是前面说的 <code>curl</code> 需要的表单。</p><ol start=6 type=1><li>用<code>curl</code>登录，在终端（Linux，Mac）cmd（Windows）输入命令，可以在登出后测试。</li></ol><div class=sourceCode id=cb4><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true></a><span class=ex>curl</span> -d <span class=st>&quot;DDDDD=245235&quot;</span> -d <span class=st>&quot;upass=tsaeitonsr&quot;</span> -d <span class=st>&quot;0MKKey=%B5%C7%A1%A1%C2%BC&quot;</span> http://172.30.255.2/a30.html</span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true></a><span class=co># 换上你的帐号密码</span></span></code></pre></div><p><strong>update: 可以直接右键复制为 <code>cURL</code></strong></p><ol start=7 type=1><li>脚本化</li></ol><ul><li>windows 桌面新建一个<code>drcom.cmd</code>，然后把上面这个命令拷进去，下次双击就可以执行啦。</li><li>Linux、Mac 在桌面或者别的地方建一个<code>drcom.sh</code>，然后拷贝上面的命令到这个文件里。添加<code>#!/bin/sh</code>作为第一行，保存。通过<code>chmod +x drcom.sh</code>添加执行权限。<ul><li>Linux 双击或者选择用终端打开就可以了</li><li>Mac 右键选择打开方式 > 启用：所有应用程序，始终以此方式打开 > 实用工具 > 终端</li></ul></li></ul><p>多说一句那一行的意思，在终端执行<code>./drcom.sh</code>时，系统会用<code>/bin/sh</code>来解释执行，它等同于在终端使用<code>/bin/sh drcom.sh</code>，如果你有 python 程序，在添加<code>#/bin/python</code>（自己注意 python 的位置和版本）后，可以使用<code>./script.py</code>来用 python 执行，当然<code>./drcom.sh</code>的前提是文件有执行权限。</p><h3 id=查询宿舍电费>查询宿舍电费</h3><p>第二个例子是“查询宿舍电费”</p><p>查询路径：</p><pre class=mermaid><code>graph LR
%%TB
A(内部网) --&gt; B(学生事务)
B --&gt; C(宿舍用电查询)</code></pre><p>用同样的方法，只不过这次的脚本相比于登录校园网，需要生成时间，并解析HTML。</p><div class=sourceCode id=cb6><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb6-1><a href=#cb6-1 aria-hidden=true></a><span class=co>#!/bin/bash</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true></a></span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true></a><span class=co># get from curl</span></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true></a><span class=va>dormitory=</span>1632</span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true></a><span class=va>roomId=</span>8780</span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true></a></span>
<span id=cb6-7><a href=#cb6-7 aria-hidden=true></a><span class=co># Send an email when the battery is below 20</span></span>
<span id=cb6-8><a href=#cb6-8 aria-hidden=true></a><span class=va>mail_threshold=</span>20</span>
<span id=cb6-9><a href=#cb6-9 aria-hidden=true></a><span class=va>mail_address=</span><span class=op>&lt;</span><span class=ex>mail</span> address<span class=op>&gt;</span></span>
<span id=cb6-10><a href=#cb6-10 aria-hidden=true></a></span>
<span id=cb6-11><a href=#cb6-11 aria-hidden=true></a><span class=va>today=$(</span><span class=fu>date</span> -d today +%Y-%m-%d<span class=va>)</span></span>
<span id=cb6-12><a href=#cb6-12 aria-hidden=true></a><span class=va>three_days_ago=$(</span><span class=fu>date</span> -d 3-days-ago +%Y-%m-%d<span class=va>)</span></span>
<span id=cb6-13><a href=#cb6-13 aria-hidden=true></a></span>
<span id=cb6-14><a href=#cb6-14 aria-hidden=true></a><span class=va>today_y=$(</span><span class=fu>date</span> -d today +%Y<span class=va>)</span></span>
<span id=cb6-15><a href=#cb6-15 aria-hidden=true></a><span class=va>three_days_ago_y=$(</span><span class=fu>date</span> -d 3-days-ago +%Y<span class=va>)</span></span>
<span id=cb6-16><a href=#cb6-16 aria-hidden=true></a></span>
<span id=cb6-17><a href=#cb6-17 aria-hidden=true></a><span class=co>#echo $three_days_ago</span></span>
<span id=cb6-18><a href=#cb6-18 aria-hidden=true></a><span class=co>#echo $today</span></span>
<span id=cb6-19><a href=#cb6-19 aria-hidden=true></a></span>
<span id=cb6-20><a href=#cb6-20 aria-hidden=true></a><span class=va>html=$(</span><span class=ex>curl</span> -s <span class=kw>\</span></span>
<span id=cb6-21><a href=#cb6-21 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;beginTime=</span><span class=va>$three_days_ago</span><span class=st>&quot;</span> <span class=kw>\</span></span>
<span id=cb6-22><a href=#cb6-22 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;endTime=</span><span class=va>$today</span><span class=st>&quot;</span> <span class=kw>\</span></span>
<span id=cb6-23><a href=#cb6-23 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;type=2&quot;</span> <span class=kw>\</span></span>
<span id=cb6-24><a href=#cb6-24 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;roomId=</span><span class=va>$roomId</span><span class=st>&quot;</span> <span class=kw>\</span></span>
<span id=cb6-25><a href=#cb6-25 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;roomName=</span><span class=va>$dormitory</span><span class=st>                &quot;</span> <span class=kw>\</span></span>
<span id=cb6-26><a href=#cb6-26 aria-hidden=true></a>    <span class=ex>-d</span> <span class=st>&quot;client=192.168.84.110&quot;</span> <span class=kw>\</span></span>
<span id=cb6-27><a href=#cb6-27 aria-hidden=true></a>    <span class=ex>http</span>://192.168.84.3:9090/cgcSims/selectList.do<span class=va>)</span></span>
<span id=cb6-28><a href=#cb6-28 aria-hidden=true></a></span>
<span id=cb6-29><a href=#cb6-29 aria-hidden=true></a><span class=co># parse HTML</span></span>
<span id=cb6-30><a href=#cb6-30 aria-hidden=true></a><span class=va>electric_info=$(</span><span class=fu>sed</span> <span class=st>&#39;s/\r//g;s/^[ \t]*//g;/^[[:space:]]*$/d&#39;</span> <span class=op>&lt;(</span><span class=bu>echo</span> <span class=st>&quot;</span><span class=va>$html</span><span class=st>&quot;</span><span class=op>)</span> <span class=kw>|\</span></span>
<span id=cb6-31><a href=#cb6-31 aria-hidden=true></a>    <span class=fu>grep</span> -a -v <span class=st>&#39;[&lt;&gt;]&#39;</span> <span class=kw>|\</span></span>
<span id=cb6-32><a href=#cb6-32 aria-hidden=true></a>    <span class=fu>awk</span> -v dormitory=<span class=va>$dormitory</span> -v today_y=<span class=st>&quot;</span><span class=va>$today_y</span><span class=st>&quot;</span> -v three_days_ago_y=<span class=st>&quot;</span><span class=va>$three_days_ago_y</span><span class=st>&quot;</span> <span class=st>&#39;($0~dormitory),($0~today_y||$0~three_days_ago_y){print $0}&#39;</span><span class=va>)</span></span>
<span id=cb6-33><a href=#cb6-33 aria-hidden=true></a>    <span class=co>#  remove \r space return</span></span>
<span id=cb6-34><a href=#cb6-34 aria-hidden=true></a>    <span class=co># remove html tags </span></span>
<span id=cb6-35><a href=#cb6-35 aria-hidden=true></a>    <span class=co># print between dormitory and year # grammar: comma</span></span>
<span id=cb6-36><a href=#cb6-36 aria-hidden=true></a></span>
<span id=cb6-37><a href=#cb6-37 aria-hidden=true></a><span class=co># send mail</span></span>
<span id=cb6-38><a href=#cb6-38 aria-hidden=true></a><span class=va>mail_info=$(</span><span class=fu>tac</span> <span class=op>&lt;(</span><span class=bu>echo</span> <span class=st>&quot;</span><span class=va>$electric_info</span><span class=st>&quot;</span><span class=op>)</span> <span class=kw>|</span><span class=fu>awk</span> <span class=st>&#39;NR==1{print &quot;更新时间：&quot; $0};NR==4{print &quot;剩余电量：&quot; $0}&#39;</span><span class=va>)</span></span>
<span id=cb6-39><a href=#cb6-39 aria-hidden=true></a><span class=co>#electric_reserve=$(tac &lt;(echo &quot;$electric_info&quot;) |awk &#39;NR==4{print $0}&#39;)</span></span>
<span id=cb6-40><a href=#cb6-40 aria-hidden=true></a><span class=co>#echo $mail_info</span></span>
<span id=cb6-41><a href=#cb6-41 aria-hidden=true></a></span>
<span id=cb6-42><a href=#cb6-42 aria-hidden=true></a><span class=co>#echo $electric_reserve</span></span>
<span id=cb6-43><a href=#cb6-43 aria-hidden=true></a><span class=bu>:</span> <span class=va>${electric_reserve:=$(($mail_threshold</span>+1<span class=va>))}</span></span>
<span id=cb6-44><a href=#cb6-44 aria-hidden=true></a><span class=co>#echo $electric_reserve</span></span>
<span id=cb6-45><a href=#cb6-45 aria-hidden=true></a><span class=co>#electric_reserve=$(sed &#39;s/\r//&#39; &lt;&lt;&lt;$(echo &quot;$electric_reserve&quot;)) #remove the \r</span></span>
<span id=cb6-46><a href=#cb6-46 aria-hidden=true></a></span>
<span id=cb6-47><a href=#cb6-47 aria-hidden=true></a><span class=kw>if</span><span class=bu> [</span> <span class=st>&quot;</span><span class=va>$(</span><span class=fu>bc</span> <span class=op>&lt;&lt;&lt;</span><span class=va>$(</span><span class=bu>echo</span> -e <span class=st>&quot;</span><span class=va>$electric_reserve</span><span class=st> &lt; </span><span class=va>$mail_threshold</span><span class=st>&quot;</span><span class=va>))</span><span class=st>&quot;</span> <span class=ot>-eq</span> 1<span class=bu> ]</span>; <span class=kw>then</span></span>
<span id=cb6-48><a href=#cb6-48 aria-hidden=true></a>    <span class=bu>echo</span> -e <span class=st>&quot;Subject: 宿舍电费\n\n</span><span class=va>$mail_info</span><span class=st>\n记得及时充电费哦. \n\nRaspberrypi\n</span><span class=va>$(</span><span class=fu>date</span><span class=va>)</span><span class=st>&quot;</span> <span class=kw>|</span> <span class=ex>sendmail</span> <span class=va>$mail_address</span></span>
<span id=cb6-49><a href=#cb6-49 aria-hidden=true></a><span class=kw>fi</span></span></code></pre></div><hr><h2 id=drcom-自动登录>drcom 自动登录</h2><p>断网了就要重新去点运行脚本好麻烦，那能不能连上校园网断网自动重连呢？</p><p>思路是：</p><ul><li>WIFI:</li></ul><ol type=1><li>获取当前连着的 WIFI 的名字</li><li>如果那个需要登录的 WIFI 名，包含在当前连着的 WIFI 里（分 <code>172</code> 和 <code>192</code>），就尝试 <code>ping baidu.com</code></li><li>如果 <code>ping</code> 不通，就用 <code>curl</code> 登录</li></ol><ul><li>以太网：</li></ul><ol type=1><li>比较网关的 mac 地址 （分 <code>172</code> 和 <code>192</code>) 和预存是否一样，这里可能每到一个新地方就要添加一下挺麻烦的。</li><li>如果一样，则尝试 <code>ping baidu.com</code></li><li>如果 <code>ping</code> 不通，就用 <code>curl</code> 登录</li></ol><p>我已经将它写好了，放在 <a href=https://github.com/BenSYZ/tools-in-szu>github</a> 上。 * 一般情况把卡号和密码改上，运行一下 install 就可以了，如果有问题欢迎留言和提 issue。 * 需要修改 <code>drcom.cmd</code>/<code>drcom.sh</code> 里的卡号、密码、以太网的设备名和 mac 地址，保存后然后运行 install * WIFI 名称不一定非得是 SZU_WLAN, SZU_NewFi，可以加上自己的路由器的 WIFI 名，这样打开电脑，连上这个 WIFI，也会尝试登录的。 * 如果是别的学校的同学可能需要自己修改一下内容啦</p><p>需要注意的是：如果你在宿舍跑着这个脚本，就不能在食堂用手机登录啦，会自动踢下线的，但是教学区和宿舍区是分开的（192 和 172 是分开的）。</p><h3 id=windows>Windows</h3><p>Install 后相关文件：</p><pre><code>C:\Users\%username%\drcom\drcom_autologin\
C:\Users\%username%\drcom\drcom_autologin\drcom.sh
C:\Users\%username%\drcom\drcom_autologin\drcom.vbs
C:\Users\%username%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\drcom.vbs -&gt; C:\Users\%username%\drcom\drcom_autologin\drcom.vbs</code></pre><p>用<code>vbs</code>启动 <code>cmd</code>，发送这个<code>vbs</code>的快捷方式到开机启动的目录，就可以实现开机自启动了。</p><h3 id=linux>Linux</h3><p>Install 后相关文件：</p><pre><code>~/.local/bin/drcom.sh
~/.config/systemd/user/drcom.service</code></pre><h4 id=requirements>Requirements</h4><ul><li><code>ip</code> in <code>iproute2</code></li><li><code>arp</code> in <code>net-tools</code></li></ul><p>通过 user <code>systemd</code>，在用户登录时启动脚本，</p><p>需要注意的是 <strong>用户级别的</strong> <code>systemd</code>在没登录的时候是不会启动的，我之前把树莓派上的 service 从系统级别换成用户级别，每次重启后连上树莓派的热点后都要登录，脚本好像失效了，但登录到树莓派上，又能上网了，那时让我很是困惑。</p><h3 id=mac>Mac</h3><p>Install 后相关文件：</p><pre><code>~/.local/bin/drcom.sh
~/Library/LaunchAgents/com.drcom.app.plist</code></pre><h4 id=requirements-1>Requirements</h4><ul><li><code>ip</code> in <code>iproute2mac</code></li></ul><div class=sourceCode id=cb10><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb10-1><a href=#cb10-1 aria-hidden=true></a><span class=ex>brew</span> install iproute2mac</span></code></pre></div><p>通过<code>launchctl</code>，来实现自动启动脚本。</p></div><div id=Rsidebar><div id=Avatar><img alt=avatar src=/avatar.jpg></div><ul><li><a href=/about>About Me</a></li><li><a href=/donate>Donate Me</a></li><li><a href=/>Ben's Blog</a></li></ul>除非注明，本博客所有文章皆为原创。<br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></div><div class=footer><div id=tags><a href=https://bensyz.github.io/blog/tags><i class="fas fa-tags"></i></a>
Keywords:<ul><li><a href=https://bensyz.github.io/blog/tags/curl>curl</a></li><li><a href=https://bensyz.github.io/blog/tags/spider>spider</a></li></ul></div><footer><hr><a href=/>Ben's Blog</a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<br><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33028102001039"><img alt=public_safety_record src=/icons/public_safety_icon.png>浙公网安备 33028102001039号</a>
<a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备2021032097号-1</a></footer></div></div></body></html>