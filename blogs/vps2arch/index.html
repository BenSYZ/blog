<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>将服务器的 Ubuntu 系统换成 Arch Linux</title><script src=/js/if_mobile.js></script>
<script>!function(){$("pre > code").each(function(){var s,n=$(this).parent().attr("class");n==null||n===""?$(this).addClass("hljs"):(s={js:"javascript"},s[n]&&(n=s[n]),$(this).addClass(n))})}</script><link rel=stylesheet href=/css/hljs/snazzy.css><link rel=stylesheet href=/css/hljs/line-numbers.min.css><script src=/js/hljs/highlight.min.js></script>
<script src=/js/hljs/highlightjs-line-numbers.min.js></script>
<script>hljs.highlightAll()</script><script>hljs.initLineNumbersOnLoad()</script><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=icon id=light-scheme-icon href=/favicons/favicon_B_Light.ico type=image/x-icon><link rel=icon id=dark-scheme-icon href=/favicons/favicon_B_Dark.ico type=image/x-icon><script src=/js/favicon.js></script></head><body><div class=container><div class=header><h1>将服务器的 Ubuntu 系统换成 Arch Linux</h1>Mon, 2021-10-04<hr></div><div class=middle><div id=TitleWithToc><div id=TitleOfToc>将服务器的 Ubuntu 系统换成 Arch Linux</div></div><div id=content><h2 id=introduction>Introduction</h2><p>这两天腾讯在搞活动，有便宜的服务器，于是买了，如之前的阿里云一样没有 Arch Linux 的系统镜像。</p><p>早就听说了有一个叫 <code>vps2arch</code> 的脚本可以将服务器上的 Ubuntu 系统转成其他系统，然后看 <a href=https://wiki.archlinux.org/title/Install_Arch_Linux_from_existing_Linux（简体中文）#从一个主机运行另一个%20Linux%20发行版>Arch wiki</a> 的时候发现了不止它，还有好多，它还介绍了如何手动转到 Arch Linux。玩 Arch 的人怎么能不手动试试呢🤪（发现这个脚本是在原来阿里云过期之后的事了。然后一直没机会，虽然虚拟机上也行，但懒啊)</p><p>然而 Arch wiki 在后面<a href=https://wiki.archlinux.org/title/Install_Arch_Linux_from_existing_Linux（简体中文）#安装提示>安装提示</a> 那节让我从 <a href=https://wiki.archlinux.org/title/Installation_guide_（简体中文）>Installation Guide</a> 中的重新分区开始，继续后面的操作，我就这样试了，然后….🤦系统挂了。那个时候也没懂原理，一开始的想法是是否能够把系统全加载到内存中，然后就可以把原分区删了重新分区，然后又看到 wiki 是这样说的，就尽信了。</p><p>后来我找到了这篇<a href=https://blog.inkuang.com/2020/114/>博客</a>，然后就成啦，原来后面的步骤是“挂载分区”而不是”建立分区“。</p><p>写博客的时候才发现，原来中文手册里说的就是“挂载”，而英文手册里是“分区” 😠 ，当然现在我把它改好啦😏</p><h2 id=原理>原理</h2><p>通过 <code>chroot</code> 进入 Arch Linux 系统，删除原 Ubuntu 系统文件，此时原来系统的内核还在内存中，我们通过 Arch Linux 系统向这个内核发送指令。 <em>内核</em> 和 <em>操作系统</em> 的关系可以看看我的这篇关于 <a href=https://bensyz.github.io/blog/blogs/gpio/>gpio</a> 的文章。</p><p>在这里操作系统可以简单理解为你能看到的各种文件，除了内核把一些内核空间的文件映射到文件系统内的文件，比方说 <code>/proc</code> <code>/sys</code> <code>/run</code> 下的各种文件等等，还有设备文件夹 <code>/dev</code> 下的内容也应该是内核生成出来的。我们通过 Arch linux 系统向原内核发送命令是怎么发送的，举个例子：我们可以通过 <code>ls</code> 查看当前目录下的文件，那这个命令对应的是这个命令文件本身 <code>/bin/ls</code> 和它所依赖的各种库 （通过 <code>ldd /bin/ls</code> 可以查看）这里的库类似于 python 的包。现在我们有 Arch 这个完整的 chroot 的系统，那当然可以向内核发送命令啦。</p><h2 id=实验>实验</h2><p><strong>注意</strong>: 记得对当前系统创建快照，因为有可能网不好，而你又还没配置好系统，那就没了….</p><p>按照 Arch wiki <a href=https://wiki.archlinux.org/title/Install_Arch_Linux_from_existing_Linux_（简体中文）>Install Arch Linux from existing Linux</a></p><h3 id=去这里-挑个镜像网站下-bootstrap-的-tar-包放到-tmp-解压>1. 去<a href=https://archlinux.org/download/>这里</a> 挑个镜像网站，下 bootstrap 的 tar 包，放到 <code>/tmp</code> ，解压：</h3><pre class=shell><code># tar xzf /tmp/archlinux-bootstrap-...-x86_64.tar.gz</code></pre><h3 id=编辑-mirrorlist>2. 编辑 <code>mirrorlist</code></h3><p>由于 bootstrap 中没有编辑器，你需要先编辑 <code>mirrorlist</code> ，选一个镜像网站</p><pre class=shell><code># vim /tmp/root.x86_64/etc/pacman.d/mirrorlist</code></pre><p>如果忘记了，然后 Ubuntu 系统又删了，可以使用 <code>sed</code> 或者<code>echo >></code></p><pre class=shell><code># sed -i &#39;s/#\(.*ustc.*\)/\1/p&#39; /etc/pacman.d/mirrorlist</code></pre><h3 id=chroot>3. <code>chroot</code></h3><p>将这个目录绑到这个目录，大概率是要这条 <code>mount</code> 的，应该是意味着这是一个 mount point，这样在 <code>chroot</code> 的时候不会有警告。并 <code>chroot</code></p><pre class=shell><code># mount --bind /tmp/root.x86_64 /tmp/root.x86_64</code></pre><pre class=shell><code># /tmp/root.x86_64/bin/arch-chroot /tmp/root.x86_64/</code></pre><p><code>arch-chroot</code> 相对于 <code>chroot</code> 的区别在于，它把一些内核空间的目录挂载到了 <code>chroot</code> 环境中，可以看 Arch wiki 的 <a href=https://wiki.archlinux.org/title/Install_Arch_Linux_from_existing_Linux_（简体中文）#安装提示>方法一：使用 Bootstrap 镜像</a>节</p><h3 id=初始化-pacman-密钥>4. 初始化 <code>pacman</code> 密钥</h3><pre class=shell><code># pacman-key --init
# pacman-key --populate archlinux</code></pre><h3 id=把分区再挂到-chroot-的-mnt-下>5. 把分区再挂到 <code>chroot</code> 的 <code>/mnt</code> 下</h3><p>我们这个时候可以看一下分区表：</p><div class=sourceCode id=cb7><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true></a>$ <span class=ex>lsblk</span></span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true></a><span class=ex>NAME</span>   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span>
<span id=cb7-3><a href=#cb7-3 aria-hidden=true></a><span class=ex>sr0</span>     11:0    1 145.7M  0 rom</span>
<span id=cb7-4><a href=#cb7-4 aria-hidden=true></a><span class=ex>vda</span>    254:0    0    80G  0 disk</span>
<span id=cb7-5><a href=#cb7-5 aria-hidden=true></a><span class=kw>|</span><span class=ex>-vda1</span> 254:1    0     1M  0 part</span>
<span id=cb7-6><a href=#cb7-6 aria-hidden=true></a>└<span class=ex>-vda2</span> 254:2    0    80G  0 part /etc/resolv.conf</span>
<span id=cb7-7><a href=#cb7-7 aria-hidden=true></a>                                 <span class=ex>/mnt</span></span></code></pre></div><p><code>/etc/resolve.conf</code> 是 <code>arch-chroot</code> 导致的，这里的 <code>/mnt</code> 就是 Installation guide 中的 <code>/mnt</code> 了。</p><h3 id=删-ubuntu-的系统文件>6. 删 Ubuntu 的系统文件</h3><p>现在可以删除 Ubuntu 的系统文件了。(Ubuntu 也是 GNU 系统的一种） 但要注意不要删掉 <code>/tmp</code> , <code>/dev</code> , <code>/proc</code> , <code>/run</code> , <code>/sys</code> 。因为 <code>/tmp</code> 里有 bootstrap 解压后的文件，也就是我们现在在使用的 Arch Linux 的系统文件，后面 4 个是内核映射到文件系统的文件，也不能删，你也可以保留你的 <code>/home</code> 目录，如果需要保留其他根目录下的配置文件，记得备份，因为 arch 在安装的过程中也会覆盖。</p><p>当然你也可以不删，安装好之后再用 <a href=https://wiki.archlinux.org/title/Pacman/Tips_and_tricks#Identify_files_not_owned_by_any_package>pacman 列出来</a>，不要在改了配置之后再删哦，有些类似 <code>/etc/hostname</code> 是不被 <code>pacman</code> 跟踪的</p><pre class=shell><code># find /etc /usr /opt | LC_ALL=C pacman -Qqo - 2&gt;&amp;1 &gt;&amp;- &gt;/dev/null | cut -d &#39; &#39; -f 5-</code></pre><h3 id=按照-installation-guide安装-arch-linux>7. 按照 <a href=https://wiki.archlinux.org/title/Installation_guide_（简体中文）#安装>Installation guide</a>，安装 Arch Linux。</h3><p>这里只是提一下需要哪些</p><ol type=1><li><p>安装：<code>pacstrap /mnt base linux linux-firmware</code></p></li><li><p>分区：<code>genfstab -U /mnt >> /mnt/etc/fstab</code></p></li><li><p><code>arc:chroot /mnt</code></p></li><li><p>时区：<code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</code> , <code>hwclock --systohc</code></p></li><li><p>文字编码：<code>/etc/locale.gen</code> <code>locale-gen</code></p></li><li><p>grub:</p></li></ol><div class=sourceCode id=cb9><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb9-1><a href=#cb9-1 aria-hidden=true></a><span class=ex>pacman</span> -s intel-ucode</span>
<span id=cb9-2><a href=#cb9-2 aria-hidden=true></a><span class=ex>grub-install</span> --target=i386-pc /dev/vda</span>
<span id=cb9-3><a href=#cb9-3 aria-hidden=true></a><span class=ex>grub-mkconfig</span> -o /boot/grub/grub.cfg<span class=kw>`</span></span></code></pre></div><ol start=6 type=1><li>网络：<code>/etc/hostname</code> , <code>/etc/hosts</code> , <code>/etc/systemd/network/en.network</code> ，enable it</li></ol><pre class=conf><code>[Match]
Name=en*
# arch 是 ens5 这种的
# Ubuntu 的网卡名还是 eth0
# 不放心可以用 e*

[Network]
DHCP=ipv4</code></pre><ol start=8 type=1><li><p><code>pacman -S neovim openssh sudo</code> , enable ssh</p></li><li><p>用户、密码、 <code>sudo</code> : <code>passwd</code> , <code>useradd -a -G wheel ben</code> , <code>passwd ben</code> , <code>visudo</code></p></li></ol><h3 id=重启>7. 重启</h3><p>如果启动失败可以通过 VNC 的方式登录，可以看到 grub 等界面</p></div><div id=Rsidebar><div id=Avatar><img alt=avatar src=/avatar.jpg></div><ul><li><a href=/about>About Me</a></li><li><a href=/donate>Donate Me</a></li><li><a href=/>Ben's Blog</a></li></ul>除非注明，本博客所有文章皆为原创。<br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></div><div class=footer><div id=tags><a href=https://bensyz.github.io/blog/tags><i class="fas fa-tags"></i></a>
Keywords:<ul><li><a href=https://bensyz.github.io/blog/tags/arch-chroot>arch-chroot</a></li><li><a href=https://bensyz.github.io/blog/tags/Linux>Linux</a></li><li><a href=https://bensyz.github.io/blog/tags/Install-Arch>Install Arch</a></li></ul></div><footer><hr><a href=/>Ben's Blog</a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<br><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33028102001039"><img alt=public_safety_record src=/icons/public_safety_icon.png>浙公网安备 33028102001039号</a>
<a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备2021032097号-1</a></footer></div></div></body></html>