<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>migrate from ubuntu16.04 to ubuntu20.04</title><script src=/js/if_mobile.js></script>
<script>!function(){$("pre > code").each(function(){var s,n=$(this).parent().attr("class");n==null||n===""?$(this).addClass("hljs"):(s={js:"javascript"},s[n]&&(n=s[n]),$(this).addClass(n))})}</script><link rel=stylesheet href=/css/hljs/snazzy.css><link rel=stylesheet href=/css/hljs/line-numbers.min.css><script src=/js/hljs/highlight.min.js></script>
<script src=/js/hljs/highlightjs-line-numbers.min.js></script>
<script>hljs.highlightAll()</script><script>hljs.initLineNumbersOnLoad()</script><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=icon id=light-scheme-icon href=/favicons/favicon_B_Light.ico type=image/x-icon><link rel=icon id=dark-scheme-icon href=/favicons/favicon_B_Dark.ico type=image/x-icon><script src=/js/favicon.js></script></head><body><div class=container><div class=header><h1>migrate from ubuntu16.04 to ubuntu20.04</h1>Thu, 2023-04-13<hr></div><div class=middle><div id=TitleWithToc><div id=TitleOfToc>migrate from ubuntu16.04 to ubuntu20.04</div></div><div id=content><p>公司服务器需要升级系统</p><ol type=1><li>系统升级</li><li>docker 迁移</li></ol><h2 id=系统升级>系统升级</h2><ol type=1><li>download and extra to new root</li></ol><div class=sourceCode id=cb1><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true></a><span class=ex>curl</span> https://cdimage.ubuntu.com/ubuntu-base/releases/focal/release/ubuntu-base-20.04.5-base-amd64.tar.gz <span class=kw>|</span> <span class=fu>sudo</span> tar -xzvf - -C /mnt</span></code></pre></div><ol start=2 type=1><li>update and install grub and other needs</li></ol><ul><li><code>grub-efi-amd64</code> # 可能直接 grub 就好，不知道这种基础组建要怎么一下安装</li><li><code>ubuntu-minimal</code></li><li><code>linux-image-generic</code></li></ul><ol start=3 type=1><li>然后参考 archlinux wiki installation guide 做些必要的动作，不要忘了 <code>systemd-networkd</code> 和 <code>sshd</code></li></ol><p>特别关注 grub</p><ul><li><code>grub-install</code></li><li><code>grub-config</code></li><li><code>efibootmgr</code> check 一下</li></ul><h2 id=docker-迁移>docker 迁移</h2><h3 id=rsync>1. <code>rsync</code></h3><div class=sourceCode id=cb2><pre class="sourceCode sh"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true></a><span class=co># https://blog.lilydjwg.me/2013/12/29/rsync-btrfs-dm-crypt-full-backup.42219.html</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true></a><span class=fu>rsync</span> --archive --one-file-system --inplace --hard-links <span class=kw>\</span></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true></a>  <span class=ex>--human-readable</span> --numeric-ids --delete --delete-excluded <span class=kw>\</span></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true></a>  <span class=ex>--acls</span> --xattrs --sparse <span class=kw>\</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true></a>  <span class=ex>--itemize-changes</span> --verbose --progress <span class=kw>\</span></span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true></a>  <span class=ex>/var/lib/docker</span> /mnt/var/lib</span></code></pre></div><p>注意最后 不要变成 <code>/mnt/var/lib</code> 否则就变成 <code>/mnt/var/lib/docker/docker</code>….</p><h3 id=docker-复杂的点在-nvidia>2. Docker 复杂的点在 nvidia</h3><p>Copy /etc/docker/</p><p>然后 docker 就 起不来了。日志</p><pre class=log><code>E: Unable to locate package nvidia-container-toolkit-base</code></pre><p>然后找到这个</p><p>https://gitlab.com/nvidia/container-toolkit/container-toolkit/-/tree/main/</p><blockquote><p>The NVIDIA Container Toolkit allows users to build and run GPU accelerated containers. The toolkit includes a container runtime library and utilities to automatically configure containers to leverage NVIDIA GPUs.</p></blockquote><p>也就时说 container 要使用 <code>nvidia</code> 需要装 <code>nvidia-container-toolkit</code>(也就是 <code>/etc/docker/daemon.json</code> 中这行的作用 <code>"path": "nvidia-container-runtime"</code>)</p><p>安装分两个</p><ol type=1><li>nvidia driver https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#nvidia-drivers</li><li>nvidia-container-toolkit https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#installation-guide</li></ol><p>其实是一篇文档…关于安装 <code>nvidia-container-toolkit</code> 的</p><h4 id=安装-nvidia-container-toolkit>安装 <code>nvidia-container-toolkit</code></h4><h5 id=pre-requests>pre-requests</h5><p>注意左侧目录层次，Pre-Requisites 只包含两个 （我看走眼了 Container Device Interface (CDI) Support 这个不是必须的，这节说要装 <code>nvidia-container-toolkit-base</code> 不是很明白）</p><ul><li>NVIDIA Drivers （这个选用包管理器安装的 https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html#package-manager , 并且不用管 post-installation steps 这个是 cuda 的，我们这里不需要 cuda，只要 driver)</li><li>Platform Requirements (默认够了)</li></ul><h5 id=nvidia-container-toolkit><code>nvidia-container-toolkit</code></h5><p>参照 https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker</p><p>这里有一点是 20.04 是指向 18.04 的源，文档里也有说，然后就 ok 了。</p><p>由于已开始 rsync 那里敲错了，之前的几个 container, image 都没找到，所以怀疑是迁移出了问题，然后就看到了这个。。。如何迁移？删除。。。不过，有可能是提交成一个 image 再新开 container 就可以了，由于我们以前用的是 nvidia-docker 2 的，就没关系了。</p><p>https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/migrating-from-1.0.html#migration-1-0</p></div><div id=Rsidebar><div id=Avatar><img alt=avatar src=/avatar.jpg></div><ul><li><a href=/about>About Me</a></li><li><a href=/donate>Donate Me</a></li><li><a href=/>Ben's Blog</a></li></ul>除非注明，本博客所有文章皆为原创。<br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></div><div class=footer><div id=tags><a href=https://bensyz.github.io/blog/tags><i class="fas fa-tags"></i></a>
Keywords:<ul><li><a href=https://bensyz.github.io/blog/tags/Linux>Linux</a></li><li><a href=https://bensyz.github.io/blog/tags/docker>docker</a></li><li><a href=https://bensyz.github.io/blog/tags/NVIDIA>NVIDIA</a></li></ul></div><footer><hr><a href=/>Ben's Blog</a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<br><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33028102001039"><img alt=public_safety_record src=/icons/public_safety_icon.png>浙公网安备 33028102001039号</a>
<a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备2021032097号-1</a></footer></div></div></body></html>