<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>polkit</title><script src=/js/if_mobile.js></script>
<script>!function(){$("pre > code").each(function(){var s,n=$(this).parent().attr("class");n==null||n===""?$(this).addClass("hljs"):(s={js:"javascript"},s[n]&&(n=s[n]),$(this).addClass(n))})}</script><link rel=stylesheet href=/css/hljs/snazzy.css><link rel=stylesheet href=/css/hljs/line-numbers.min.css><script src=/js/hljs/highlight.min.js></script>
<script src=/js/hljs/highlightjs-line-numbers.min.js></script>
<script>hljs.highlightAll()</script><script>hljs.initLineNumbersOnLoad()</script><link rel=stylesheet href=/css/code.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/footer.css><link rel=stylesheet href=/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=icon id=light-scheme-icon href=/favicons/favicon_B_Light.ico type=image/x-icon><link rel=icon id=dark-scheme-icon href=/favicons/favicon_B_Dark.ico type=image/x-icon><script src=/js/favicon.js></script></head><body><div class=container><div class=header><h1>polkit</h1>Mon, 2022-06-06<br>本文最后修改于 Thu, 2022-09-15<hr></div><div class=middle><div id=TitleWithToc><div id=TitleOfToc>polkit</div></div><div id=content><h1 id=polkit>polkit</h1><h2 id=introduction>Introduction</h2><h3 id=问题的出现>问题的出现</h3><p><code>udisks2</code> 可以在系统启动后的自动挂载和卸载，但是对于开机时它不会自动挂载所有的分区，我们需要 <code>/etc/fstab</code> 来自动挂载的分区。但由 <code>/etc/fstab</code> 挂载的分区却不能直接用 <code>udisks2</code> 卸载。(虽然加上 <code>users</code> 这个 option 可以不用 sudo 直接 umount，但 <code>udisks2</code> 限制了这种动作,后面会提到的 <code>org.freedesktop.udisks2.filesystem-unmount-others</code>)。又由于 File explorer 中点击卸载，使用的是 <code>udisks2</code>，所以对于前述的情况，便不能通过鼠标点击卸载。</p><h3 id=about-polkit>about polkit</h3><p>polkit 实现非特权进程向特权进程发消息的控制，从而可控地让非特权进程达到特权功能，比如，普通用户的挂载和卸载硬盘</p><p>polkit 配置有两种方式，一种是应用自带的，叫Action，(<code>.policy</code>)；另一种是类似补丁的形式，叫Authorization rules,(<code>.rules</code> or <code>.pkla</code>)</p><h2 id=action>Action:</h2><p>policy file 文件位置：</p><p><code>/usr/share/polkit-1/actions/*.policy</code></p><p>在 default section 中，有这几个选项:</p><ul><li>keys:<ul><li><code>allow_any</code>: 所有</li><li><code>allow_inactive</code>: 远程的 session(ssh vnc, etc.)</li><li><code>allow_active</code>: 本地 tty, X display</li></ul></li><li>values:<ul><li><code>no</code>: 无权限</li><li><code>yes</code>: 有权限</li><li><code>auth_self[_keep]</code>: 对 non-sudoer [keep some minutes] 开放权限</li><li><code>auth_admin[_keep]</code>: sudoer 开放权限</li></ul></li></ul><h2 id=authorization-rules>Authorization rules</h2><p>文件位置：</p><p><code>/etc/polkit-1/rules.d/*.rules</code></p><p>Tips:</p><ul><li>顺序是 <code>00-test.rules</code> 比 <code>99-test.rules</code> 更早验证，即，后面的不会覆写前面的。（区别于 <code>/etc/udev/hwdb.d/</code>）因为这里直接 return 了</li><li><code>subject.local: true/false</code> responding to <code>allow_active</code>, etc in policy</li><li><code>systemctl status polkit</code> 可以查看 <code>Action name</code></li></ul><h3 id=examples>examples:</h3><ul><li><p><code>addAdminRule()</code> 需要特权时，使用何种身份验证是否有特权</p><pre class=rules><code># wheel 组的用户就可以使用这个特权
polkit.addAdminRule(function(action, subject) {
    return [&quot;unix-group:wheel&quot;];
});</code></pre><pre class=console><code>$ systemctl restart polkit.service
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====
Authentication is required to restart &#39;polkit.service&#39;.
Authenticating as: ben (ben is in wheel)</code></pre><pre class=rules><code># root 用户才可以使用这个特权
polkit.addAdminRule(function(action, subject) {
    return [&quot;unix-user:root&quot;];
});</code></pre><pre class=console><code>$ systemctl restart polkit.service
==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ====
Authentication is required to restart &#39;polkit.service&#39;.
Authenticating as: root</code></pre></li><li><p><code>addRule()</code></p><ul><li><p>change rule</p><pre class=rules><code>polkit.addRule(function(action, subject) {
    if (action.id == &quot;org.gnome.gparted&quot; &amp;&amp;
        subject.isInGroup(&quot;admin&quot;)) {
        return polkit.Result.YES;
    }
});</code></pre></li><li><p>log</p><pre class=rules><code>polkit.addRule(function(action, subject) {
    if (action.id == &quot;org.freedesktop.policykit.exec&quot;) {
        polkit.log(&quot;action=&quot; + action);
        polkit.log(&quot;subject=&quot; + subject);
    }
});</code></pre></li></ul></li></ul><h3 id=old-authorization-rules>old Authorization rules</h3><p><code>pkaction --version</code>, rules not work for pkaction less then 106</p><p><a href=https://askubuntu.com/questions/536591/policykit-rules-never-come-into-effect class=uri>https://askubuntu.com/questions/536591/policykit-rules-never-come-into-effect</a></p><pre class=conf><code>#/etc/polkit-1/localauthority/50-local.d/00-udisk-umount.pkla
# section: random name
# man pklocalauthority(8)
[Allow]
Identity=unix-user:*
Action=org.freedesktop.udisks2.filesystem-unmount-others
ResultAny=yes
ResultInactive=no
ResultActive=yes</code></pre><p>(似乎 <code>ResultAny</code> 和 <code>ResultActive</code> 有优先级，如果这里只设置 <code>ResultAny=yes</code>，默认的 <code>ResultActive</code> 还是 <code>no</code>，还是不生效)</p><h2 id=问题的解决>问题的解决</h2><p><code>pkaction --version</code> 106 及以上的</p><pre class=rules><code>#/etc/polkit-1/rules.d/00-udisk-unmount-others.rules
polkit.addRule(function(action, subject) {
    if (action.id == &quot;org.freedesktop.udisks2.filesystem-unmount-others&quot; ){
        return polkit.Result.YES;
    }
});</code></pre><p><code>pkaction --version</code> 低于 106 的</p><pre class=conf><code>#/etc/polkit-1/localauthority/50-local.d/00-udisk-umount.pkla
[Allow]
Identity=unix-user:*
Action=org.freedesktop.udisks2.filesystem-unmount-others
ResultAny=yes
ResultInactive=no
ResultActive=yes</code></pre><h2 id=refs>refs:</h2><ul><li><a href=https://wiki.archlinux.org/title/Polkit class=uri>https://wiki.archlinux.org/title/Polkit</a></li><li><a href=https://www.freedesktop.org/software/polkit/docs/latest/polkit.8.html class=uri>https://www.freedesktop.org/software/polkit/docs/latest/polkit.8.html</a></li></ul></div><div id=Rsidebar><div id=Avatar><img alt=avatar src=/avatar.jpg></div><ul><li><a href=/about>About Me</a></li><li><a href=/donate>Donate Me</a></li><li><a href=/>Ben's Blog</a></li></ul>除非注明，本博客所有文章皆为原创。<br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。</div></div><div class=footer><div id=tags><a href=https://bensyz.github.io/blog/tags><i class="fas fa-tags"></i></a>
Keywords:<ul><li><a href=https://bensyz.github.io/blog/tags/polkit>polkit</a></li><li><a href=https://bensyz.github.io/blog/tags/Linux>Linux</a></li><li><a href=https://bensyz.github.io/blog/tags/permission>permission</a></li><li><a href=https://bensyz.github.io/blog/tags/learns>learns</a></li><li><a href=https://bensyz.github.io/blog/tags/kenexs>kenexs</a></li></ul></div><footer><hr><a href=/>Ben's Blog</a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<br><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33028102001039"><img alt=public_safety_record src=/icons/public_safety_icon.png>浙公网安备 33028102001039号</a>
<a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备2021032097号-1</a></footer></div></div></body></html>