<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ethtool on Ben's Blog</title><link>https://bensyz.github.io/blog/tags/ethtool/</link><description>Recent content in ethtool on Ben's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 26 Apr 2022 02:32:01 +0800</lastBuildDate><atom:link href="https://bensyz.github.io/blog/tags/ethtool/index.xml" rel="self" type="application/rss+xml"/><item><title>网络断连分析工具介绍</title><link>https://bensyz.github.io/blog/blogs/network_disconnection_analysis_tool/</link><pubDate>Tue, 26 Apr 2022 02:32:01 +0800</pubDate><guid>https://bensyz.github.io/blog/blogs/network_disconnection_analysis_tool/</guid><description>&lt;h1 id="网络断连分析工具介绍">网络断连分析工具介绍&lt;/h1>
&lt;p>[toc]&lt;/p>
&lt;h2 id="抓包工具数据链路层及之上">抓包工具（数据链路层及之上）&lt;/h2>
&lt;h3 id="tcpdump">&lt;code>tcpdump&lt;/code>&lt;/h3>
&lt;ol type="1">
&lt;li>网络层：&lt;/li>
&lt;/ol>
&lt;pre class="console">&lt;code># tcpdump -i eth0&lt;/code>&lt;/pre>
&lt;ol start="2" type="1">
&lt;li>数据链路层&lt;/li>
&lt;/ol>
&lt;pre class="console">&lt;code># tcpdump -e -i eth0&lt;/code>&lt;/pre>
&lt;h3 id="wireshark">&lt;code>wireshark&lt;/code>&lt;/h3>
&lt;p>&lt;code>wireshark&lt;/code> 还是更香一点，可以直接抓，抓完还可以看流量图 (statistic-Flow graph)(一应一答的那种)&lt;/p>
&lt;p>需要注意的是通讯双方的 &lt;code>wireshark&lt;/code> 版本要保持一致，老版本的 sequence number 和新版本的对不上&lt;/p>
&lt;p>我们这次使用的是 Version 3.6.3，如果没有可以自行 &lt;a href="https://1.as.dl.wireshark.org/src/wireshark-3.6.3.tar.xz">下载&lt;/a> 编译，编译方法查看 INSTALL 文件，对于 Ubnutu 来说&lt;/p>
&lt;pre class="console">&lt;code># ./tools/debian-setup.sh
# mkdir build
# cmake -DCMAKE_INSTALL_PREFIX ..
# make -j4
# make install&lt;/code>&lt;/pre>
&lt;h2 id="phy-芯片的查看物理层">PHY 芯片的查看（物理层）&lt;/h2>
&lt;p>rtl8169 的手册：&lt;a href="https://www.semiee.com/file/EOL2/Realtek-RTL8168-LF.pdf" class="uri">https://www.semiee.com/file/EOL2/Realtek-RTL8168-LF.pdf&lt;/a>&lt;/p>
&lt;p>PHY 分 MAC 侧和 PHY 侧，我们这次主要看 PHY 是否有变化，以及 中断 mask 是否有变化导致网络中断上不来。&lt;/p>
&lt;h3 id="网上找的一个小工具-mdio">网上找的一个小工具 mdio&lt;/h3>
&lt;p>我先是找到了这个&lt;a href="https://blog.csdn.net/qq_40083589/article/details/102495601">工具&lt;/a>，但它只支持 PHY 侧的状态查询&lt;/p>
&lt;div class="sourceCode" id="cb4">&lt;pre class="sourceCode c">&lt;code class="sourceCode c">&lt;span id="cb4-1">&lt;a href="#cb4-1" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;stdio.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-2">&lt;a href="#cb4-2" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;stdlib.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-3">&lt;a href="#cb4-3" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;string.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-4">&lt;a href="#cb4-4" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;linux/mii.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-5">&lt;a href="#cb4-5" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;sys/types.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-6">&lt;a href="#cb4-6" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;sys/socket.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-7">&lt;a href="#cb4-7" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;sys/ioctl.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-8">&lt;a href="#cb4-8" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;net/if.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-9">&lt;a href="#cb4-9" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;linux/sockios.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-10">&lt;a href="#cb4-10" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;linux/types.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-11">&lt;a href="#cb4-11" aria-hidden="true">&lt;/a>&lt;span class="pp">#include &lt;/span>&lt;span class="im">&amp;lt;netinet/in.h&amp;gt;&lt;/span>&lt;/span>
&lt;span id="cb4-12">&lt;a href="#cb4-12" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-13">&lt;a href="#cb4-13" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-14">&lt;a href="#cb4-14" aria-hidden="true">&lt;/a>&lt;span class="pp">#define reteck(ret) \&lt;/span>&lt;/span>
&lt;span id="cb4-15">&lt;a href="#cb4-15" aria-hidden="true">&lt;/a>&lt;span class="pp"> if(ret &amp;lt; 0){ \&lt;/span>&lt;/span>
&lt;span id="cb4-16">&lt;a href="#cb4-16" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;%m! \&amp;quot;%s\&amp;quot; : line: %d\n&amp;quot;, __func__, __LINE__); \&lt;/span>&lt;/span>
&lt;span id="cb4-17">&lt;a href="#cb4-17" aria-hidden="true">&lt;/a>&lt;span class="pp"> goto lab; \&lt;/span>&lt;/span>
&lt;span id="cb4-18">&lt;a href="#cb4-18" aria-hidden="true">&lt;/a>&lt;span class="pp"> }&lt;/span>&lt;/span>
&lt;span id="cb4-19">&lt;a href="#cb4-19" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-20">&lt;a href="#cb4-20" aria-hidden="true">&lt;/a>&lt;span class="pp">#define help() \&lt;/span>&lt;/span>
&lt;span id="cb4-21">&lt;a href="#cb4-21" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;mdio:\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-22">&lt;a href="#cb4-22" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;read operation: mdio reg_addr\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-23">&lt;a href="#cb4-23" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;write operation: mdio reg_addr value\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-24">&lt;a href="#cb4-24" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;For example:\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-25">&lt;a href="#cb4-25" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;mdio eth0 1\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-26">&lt;a href="#cb4-26" aria-hidden="true">&lt;/a>&lt;span class="pp"> printf(&amp;quot;mdio eth0 0 0x12\n\n&amp;quot;); \&lt;/span>&lt;/span>
&lt;span id="cb4-27">&lt;a href="#cb4-27" aria-hidden="true">&lt;/a>&lt;span class="pp"> exit(0);&lt;/span>&lt;/span>
&lt;span id="cb4-28">&lt;a href="#cb4-28" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-29">&lt;a href="#cb4-29" aria-hidden="true">&lt;/a>&lt;span class="dt">int&lt;/span> sockfd;&lt;/span>
&lt;span id="cb4-30">&lt;a href="#cb4-30" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-31">&lt;a href="#cb4-31" aria-hidden="true">&lt;/a>&lt;span class="dt">int&lt;/span> main(&lt;span class="dt">int&lt;/span> argc, &lt;span class="dt">char&lt;/span> *argv[]){&lt;/span>
&lt;span id="cb4-32">&lt;a href="#cb4-32" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-33">&lt;a href="#cb4-33" aria-hidden="true">&lt;/a> &lt;span class="cf">if&lt;/span>(argc == &lt;span class="dv">1&lt;/span> || !strcmp(argv[&lt;span class="dv">1&lt;/span>], &lt;span class="st">&amp;quot;-h&amp;quot;&lt;/span>)){&lt;/span>
&lt;span id="cb4-34">&lt;a href="#cb4-34" aria-hidden="true">&lt;/a> help();&lt;/span>
&lt;span id="cb4-35">&lt;a href="#cb4-35" aria-hidden="true">&lt;/a> }&lt;/span>
&lt;span id="cb4-36">&lt;a href="#cb4-36" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-37">&lt;a href="#cb4-37" aria-hidden="true">&lt;/a> &lt;span class="kw">struct&lt;/span> mii_ioctl_data *mii = NULL;&lt;/span>
&lt;span id="cb4-38">&lt;a href="#cb4-38" aria-hidden="true">&lt;/a> &lt;span class="kw">struct&lt;/span> ifreq ifr;&lt;/span>
&lt;span id="cb4-39">&lt;a href="#cb4-39" aria-hidden="true">&lt;/a> &lt;span class="dt">int&lt;/span> ret;&lt;/span>
&lt;span id="cb4-40">&lt;a href="#cb4-40" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-41">&lt;a href="#cb4-41" aria-hidden="true">&lt;/a> memset(&amp;amp;ifr, &lt;span class="dv">0&lt;/span>, &lt;span class="kw">sizeof&lt;/span>(ifr));&lt;/span>
&lt;span id="cb4-42">&lt;a href="#cb4-42" aria-hidden="true">&lt;/a> strncpy(ifr.ifr_name, argv[&lt;span class="dv">1&lt;/span>], IFNAMSIZ - &lt;span class="dv">1&lt;/span>);&lt;/span>
&lt;span id="cb4-43">&lt;a href="#cb4-43" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-44">&lt;a href="#cb4-44" aria-hidden="true">&lt;/a> sockfd = socket(PF_LOCAL, SOCK_DGRAM, &lt;span class="dv">0&lt;/span>);&lt;/span>
&lt;span id="cb4-45">&lt;a href="#cb4-45" aria-hidden="true">&lt;/a> reteck(sockfd);&lt;/span>
&lt;span id="cb4-46">&lt;a href="#cb4-46" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-47">&lt;a href="#cb4-47" aria-hidden="true">&lt;/a> &lt;span class="co">//get phy address in smi bus&lt;/span>&lt;/span>
&lt;span id="cb4-48">&lt;a href="#cb4-48" aria-hidden="true">&lt;/a> ret = ioctl(sockfd, SIOCGMIIPHY, &amp;amp;ifr);&lt;/span>
&lt;span id="cb4-49">&lt;a href="#cb4-49" aria-hidden="true">&lt;/a> reteck(ret);&lt;/span>
&lt;span id="cb4-50">&lt;a href="#cb4-50" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-51">&lt;a href="#cb4-51" aria-hidden="true">&lt;/a> mii = (&lt;span class="kw">struct&lt;/span> mii_ioctl_data*)&amp;amp;ifr.ifr_data;&lt;/span>
&lt;span id="cb4-52">&lt;a href="#cb4-52" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-53">&lt;a href="#cb4-53" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-54">&lt;a href="#cb4-54" aria-hidden="true">&lt;/a> &lt;span class="cf">if&lt;/span>(argc == &lt;span class="dv">3&lt;/span>){&lt;/span>
&lt;span id="cb4-55">&lt;a href="#cb4-55" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-56">&lt;a href="#cb4-56" aria-hidden="true">&lt;/a> mii-&amp;gt;reg_num = (&lt;span class="dt">uint16_t&lt;/span>)strtoul(argv[&lt;span class="dv">2&lt;/span>], NULL, &lt;span class="dv">0&lt;/span>);&lt;/span>
&lt;span id="cb4-57">&lt;a href="#cb4-57" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-58">&lt;a href="#cb4-58" aria-hidden="true">&lt;/a> ret = ioctl(sockfd, SIOCGMIIREG, &amp;amp;ifr);&lt;/span>
&lt;span id="cb4-59">&lt;a href="#cb4-59" aria-hidden="true">&lt;/a> reteck(ret);&lt;/span>
&lt;span id="cb4-60">&lt;a href="#cb4-60" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-61">&lt;a href="#cb4-61" aria-hidden="true">&lt;/a> &lt;/span>
&lt;span id="cb4-62">&lt;a href="#cb4-62" aria-hidden="true">&lt;/a> printf(&lt;span class="st">&amp;quot;read phy addr: 0x%x reg: 0x%x value : 0x%x&lt;/span>&lt;span class="sc">\n\n&lt;/span>&lt;span class="st">&amp;quot;&lt;/span>, mii-&amp;gt;phy_id, mii-&amp;gt;reg_num, mii-&amp;gt;val_out);&lt;/span>
&lt;span id="cb4-63">&lt;a href="#cb4-63" aria-hidden="true">&lt;/a> }&lt;span class="cf">else&lt;/span> &lt;span class="cf">if&lt;/span>(argc == &lt;span class="dv">4&lt;/span>){&lt;/span>
&lt;span id="cb4-64">&lt;a href="#cb4-64" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-65">&lt;a href="#cb4-65" aria-hidden="true">&lt;/a> mii-&amp;gt;reg_num = (&lt;span class="dt">uint16_t&lt;/span>)strtoul(argv[&lt;span class="dv">2&lt;/span>], NULL, &lt;span class="dv">0&lt;/span>);&lt;/span>
&lt;span id="cb4-66">&lt;a href="#cb4-66" aria-hidden="true">&lt;/a> mii-&amp;gt;val_in = (&lt;span class="dt">uint16_t&lt;/span>)strtoul(argv[&lt;span class="dv">3&lt;/span>], NULL, &lt;span class="dv">0&lt;/span>);&lt;/span>
&lt;span id="cb4-67">&lt;a href="#cb4-67" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-68">&lt;a href="#cb4-68" aria-hidden="true">&lt;/a> ret = ioctl(sockfd, SIOCSMIIREG, &amp;amp;ifr);&lt;/span>
&lt;span id="cb4-69">&lt;a href="#cb4-69" aria-hidden="true">&lt;/a> reteck(ret);&lt;/span>
&lt;span id="cb4-70">&lt;a href="#cb4-70" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-71">&lt;a href="#cb4-71" aria-hidden="true">&lt;/a> printf(&lt;span class="st">&amp;quot;write phy addr: 0x%x reg: 0x%x value : 0x%x&lt;/span>&lt;span class="sc">\n\n&lt;/span>&lt;span class="st">&amp;quot;&lt;/span>, mii-&amp;gt;phy_id, mii-&amp;gt;reg_num, mii-&amp;gt;val_in);&lt;/span>
&lt;span id="cb4-72">&lt;a href="#cb4-72" aria-hidden="true">&lt;/a> }&lt;/span>
&lt;span id="cb4-73">&lt;a href="#cb4-73" aria-hidden="true">&lt;/a>&lt;/span>
&lt;span id="cb4-74">&lt;a href="#cb4-74" aria-hidden="true">&lt;/a>lab:&lt;/span>
&lt;span id="cb4-75">&lt;a href="#cb4-75" aria-hidden="true">&lt;/a> close(sockfd);&lt;/span>
&lt;span id="cb4-76">&lt;a href="#cb4-76" aria-hidden="true">&lt;/a> &lt;span class="cf">return&lt;/span> &lt;span class="dv">0&lt;/span>;&lt;/span>
&lt;span id="cb4-77">&lt;a href="#cb4-77" aria-hidden="true">&lt;/a>}&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;p>编译后使用方法：&lt;/p>
&lt;ul>
&lt;li>读取：&lt;/li>
&lt;/ul>
&lt;pre class="console">&lt;code># ./mdio eth0 0x00&lt;/code>&lt;/pre>
&lt;ul>
&lt;li>修改：&lt;/li>
&lt;/ul>
&lt;pre class="console">&lt;code># ./mdio eth0 0x00 0x00&lt;/code>&lt;/pre>
&lt;h3 id="ethtool">&lt;code>ethtool&lt;/code>&lt;/h3>
&lt;p>ethtool 可以同时直接看 PHY侧 和 MAC 侧的 PHY 芯片的状态：&lt;/p>
&lt;pre class="console">&lt;code>ethtool -d eth0&lt;/code>&lt;/pre>
&lt;pre class="output">&lt;code>RealTek RTL8168g/8111g registers:
--------------------------------------------------------
0x00: MAC Address ma:c0:ad:dr:es:s0
0x08: Multicast Address Filter 0x02020040 0x80400083
0x10: Dump Tally Counter Command 0x1303b000 0x00000001
0x20: Tx Normal Priority Ring Addr 0x02a25000 0x00000001
0x28: Tx High Priority Ring Addr 0x00000000 0x00000000
0x30: Flash memory read/write 0x00000000
0x34: Early Rx Byte Count 0
0x36: Early Rx Status 0x00
0x37: Command 0x0c
Rx on, Tx on
0x3C: Interrupt Mask 0x003f
LinkChg RxNoBuf TxErr TxOK RxErr RxOK
0x3E: Interrupt Status 0x0000
0x40: Tx Configuration 0x53900f80
0x44: Rx Configuration 0x0002cf0e
0x48: Timer count 0x00000000
0x4C: Missed packet counter 0x000000
0x50: EEPROM Command 0x10
0x51: Config 0 0x00
0x52: Config 1 0xcf
0x53: Config 2 0x1c
0x54: Config 3 0x60
0x55: Config 4 0x11
0x56: Config 5 0x00
0x58: Timer interrupt 0x00000000
0x5C: Multiple Interrupt Select 0x0000
0x60: PHY access 0x00000000
0x64: TBI control and status 0x00000000
0x68: TBI Autonegotiation advertisement (ANAR) 0x0000
0x6A: TBI Link partner ability (LPAR) 0x0000
0x6C: PHY status 0x84
0x84: PM wakeup frame 0 0x00000000 0x00000000
0x8C: PM wakeup frame 1 0x00000000 0x00000000
0x94: PM wakeup frame 2 (low) 0x00000000 0x00000000
0x9C: PM wakeup frame 2 (high) 0x00000000 0x00000000
0xA4: PM wakeup frame 3 (low) 0x00000000 0x00000000
0xAC: PM wakeup frame 3 (high) 0x00000000 0x00000000
0xB4: PM wakeup frame 4 (low) 0x00000000 0xd20a0000
0xBC: PM wakeup frame 4 (high) 0x00000000 0x00000000
0xC4: Wakeup frame 0 CRC 0x0000
0xC6: Wakeup frame 1 CRC 0x0000
0xC8: Wakeup frame 2 CRC 0x0000
0xCA: Wakeup frame 3 CRC 0x0000
0xCC: Wakeup frame 4 CRC 0x0000
0xDA: RX packet maximum size 0x4000
0xE0: C+ Command 0x2060
VLAN de-tagging
RX checksumming
0xE2: Interrupt Mitigation 0x0000
TxTimer: 0
TxPackets: 0
RxTimer: 0
RxPackets: 0
0xE4: Rx Ring Addr 0x03fef000 0x00000001
0xEC: Early Tx threshold 0x27
0xF0: Func Event 0x0000003f
0xF4: Func Event Mask 0x00000000
0xF8: Func Preset State 0x00000003
0xFC: Func Force Event 0x00000000&lt;/code>&lt;/pre>
&lt;p>但ethtool 并不支持解析 r8168 驱动，只会返回给我们裸数据，所以我们需要添加r8168，用r8169来解析这个裸数据，并自己编译。添加的位置：是 &lt;code>driver_list[]={}&lt;/code>。虽说这可能会有些问题，有些状态不对，但由于我们只需看中断mask，所以可以直接拿来用。根据从手册上说的，r8168 和 r8169 中断mask的位置是同一个所以我们可以直接看了。&lt;/p></description></item></channel></rss>